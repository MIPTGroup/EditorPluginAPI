# ISO/IEC 228666:2021
# Унифицированный интерфейс плагинов для графических редакторов

### Что такое плагин

Плагин является расширением возможностей графического редактора. Каждый плагин является либо инструментом, либо эффектом.

- _Эффект_ - обработка, применяемая относительно всего изображения.
- _Инструмент_ - позиционная обработка, может учитывать текущее положение и состояние мыши.

### Общее описание

Плагин является разделяемой библиотекой. Для начала работы с плагином редактор загружает разделяемую библиотеку в свое адресное пространство и находит в ней функцию get_plugin_interface. Она возвращает структуру PluginInterface (см, исходник). В ней располагаются указатели на функции, реализуемые плагином и вызываемые редактором. Также в структуре указана версия Стандарта, с которым готов работать плагин. В текущей итерации Стандарта версия должна являться нулевым значением.

Функции PluginInterface, секция general:

- init - функция инициализации плагина. Редактор обязуется вызвать эту функцию при загрузке плагина, передав в нее заполненную структуру AppInterface - указатели на функции редактора. Содержимое AppInterface определяется ниже. Функция возвращает статус исполнения - если статус не PLUGIN_OK, то инициализация плагина провалилась и редактор не может продолжпть работу с плагином.

- get_info - возвращает структуру PluginInfo c базовой информацией и типом плагина - эффект или инструмент. Также содержит указатель на PluginInterface.

- deinit - деинициализация плагина. Редактор обязуется вызвать эту функцию при выгрузке плагина. Функция возвращает статус исполнения - если статус не PLUGIN_OK, то деинициализация плагина провалилась и возможны утечки памяти.

- dump - в ответ на вызов этой функции редактором плагин может вывести свое состояние глобальный лог приложения посредством функции log AppInterface (см. ниже)

- on_tick - данная функция периодически вызывается приложением, передавая в качестве аргумента время, прошедшее с предыдущего вызова в секундах

- get_flush_policy - данная функция возвращает политику плагина касательно обновления слоя. Если плагин возвращает PPLP_BLEND, то превью-слой должен альфа-смешиваться с основным, если PPLP_COPY - полностью заменять основной слой (про превью слой см. ниже)

### AppInterface

Приложение предоставляет плагину набор функций, посредством которых он может делать что-то полезное. Этот набор функций определен структурой AppInterface, которая является набором указателей на функции и передается приложением в плагин при инициализации.

Функции AppInterface:

Секция general:
- log - функция логгирования. Позволяет плагину печатать сообщения в лог программы. Сигнатура как у принтфа.
- get_absolute_time

Секция target:
- get_pixels - возвращает текущий слой как массив пикселей (как массив цветов). Возвращаемый буфер является динамическим - плагин обязуется освободить его посредством release_pixels.
- get_size - возвращает размер текущего слоя.

Секция render:
- circle - рисует круг с заданным центром, радиусом, цветом и параметрами отрисовки.
- line - рисует линию с заданным началом/концом с заданным цветом и параметрами отрисовки.
- triangle - рисует треугольник с заданными вершинами, цветом и параметрами отрисовки.
- rectangle - рисует прямоугольник со сторонами, параллельными осям координат по двум углам с заданным цветом и параметрами отрисовки.
- pixels - рисует массив пикселей заданного размера на заданном смещении и c заданными параметрами отрисовки.

Секция shader:
- кек

### Preview-слой

Для плагина видимыми являются два слоя - текущий выбранный слой (далее основной) в редакторе и preview-слой редактора. Preview слой отображается выше основного, но ниже следующего после основного в редакторе.

Поведение preview-слоя для эффекта: непосредственно перед вызовом apply preview-слой очищается прозрачным, после работы apply preview-слой смешивается/заменяет текущий (согласно политике замещения).

Поведение preview-слоя для инструмента: непосредственно перед вызовом on_press preview-слой очищается прозрачным цветом, после работы on_release preview-слой смешивается/заменяет текущий (согласно политике замещения).

### Возможности рисования для плагина

При отрисовке всех примитивов плагин передает структуру PRenderMode, позволяющую плагину определить желаемые параметры отрисовки:
- PDrawPolicy - желаемый слой для рисования - preview-слой или основной
- PBlendMode - режим смешивания - либо примитив смешивается с текущим содержимым слоя, либо пиксели примитиво заменяют пиксели слоя.

Примитивы отрисовки были описаны в описании структуры AppInterface, секция render

## Работа плагина

### Общее

Посредством функций get_color и get_size (AppInterface, секция general) плагин может узнать текущий цвет и размер. Редактор сам решает, что передавать. Подразумевается, что в качестве цвета передается текущий выбранный в палитре приложения, в качестве размера текущий выбранный размер кисти.
